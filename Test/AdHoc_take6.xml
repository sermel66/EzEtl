<?xml version="1.0" encoding="utf-8"?>
<EzEtl>
  <Base file="C:\Users\sergey\Source\Repos\EzEtl\Test\EzEtl_Common.xml" />
  
  <Variables>
    <!-- Variable ID="BatchSizeRows" value="10000" -->
    <Variable ID="TempFolder" value="${DataRoot}Temp\" />
    <Variable ID="FeedName"  	value="" />
	
	<Variable ID="FeedDate"   value="1900-01-01" type="DateTime" />
	<Variable ID="StartDate"  value="1900-01-01" type="DateTime" />
	<Variable ID="EndDate"    value="1900-01-01" type="DateTime" />
	
  </Variables>
	
  <Modules>
    <DataFlow ID="Upload">
      <Source ID="FILE">
        <FilePathPattern>C:\temp\EzEtl\PipeOut.csv</FilePathPattern>
        <SchemaIniTemplate>=${ConfigFolder}\unicode.ini</SchemaIniTemplate>
        <TempFolder>C:\temp\EzEtl\Temp\</TempFolder>
        <Encoding>utf-8</Encoding>
        <TempFileEncoding>Unicode</TempFileEncoding>
		<BatchSizeRows type="Int32">1000000</BatchSizeRows>
      </Source>

      <Destination ID="SQLBULK">
        <ConnectionStringName>MyLocalSql</ConnectionStringName>
        <TimestampColumn>FeedDate</TimestampColumn>
        <TableName>dbo.AdHoc</TableName>
		<ExistingDataAction>Truncate</ExistingDataAction>
        <DbOperationTimeout>1500</DbOperationTimeout>
		<OneDebugMessagePerBatchCount>1</OneDebugMessagePerBatchCount>
      </Destination>

    </DataFlow>
	
	<SqlExec ID="GetStartDate">
		 <ConnectionStringName>MyLocalSql</ConnectionStringName>
		 <SqlNonQuery command="dbo.StartDate">
			<Argument name="@FeedName" value="${FeedName}" direction="INPUT" />
			<Argument name="@StartDate" value="${StartDate}" direction="OUTPUT" />
		</SqlNonQuery>
	</SqlExec>
	
	<SqlExec ID="ProcessFeed">
		 <ConnectionStringName>MyLocalSql</ConnectionStringName>
		 <SqlNonQuery command="dbo.AdHocLoad">
			 <Argument  name="@FeedName" value="${FeedName}" direction="INPUT" />
			 <Argument  name="@StartDate" value="${StartDate}" direction="OUTPUT" />	 
		 </SqlNonQuery>
	</SqlExec>
	
  </Modules>

  <Workflow>
		<SetVariable ID="FeedName" value="AdHoc" />
		<ExecuteModule ID="GetStartDate" />
		<ForLoop 
				InitExpression="${FeedDate}=${StartDate}"
				EvalExpression="${FeedDate}&lt;=${EndDate}"
				AssignExpression="${FeedDate}=DATEADD(day,1,${FeedDate})">
				
			<ExecuteModule ID="Upload"/>
			<ExecuteModule ID="ProcessFeed"/>
		</ForLoop>
  </Workflow>
  
</EzEtl>